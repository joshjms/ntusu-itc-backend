<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<body>
    <h1>
        JWT Test
    </h1>
    <p>
        Run this using port 3000 only!
        using simple python sserver: python -m http.server 3000
    </p>

    <button id="get-feedbacks">
        Retrieve feedbacks (log in as superuser required)
    </button>
    <div id="feedbacks"></div>

    <div id="auth">    
        <h3>
            You are not logged in.
        </h3>
    </div>

    <form id="login-form">
        Username: <input type="text" name="username" id="username">
        Password: <input type="password" name="password" id="password">
        <button type="submit">
            Login
        </button>
        <div id="login-form-error"></div>
    </form>

    <form id="logout-form">
        <button type="submit">
            Logout
        </button>
    </form>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // you can play around while watching the console

            // get feedbacks when button is clicked
            // log in as superuser is required to get this data
            // if you are not logged in, you get 401 unauthorized error
            // if you are just a regular user, you get 403 forbidden
            // otherwise, you can get access to the data
            document.getElementById('get-feedbacks').onclick = getFeedbacks

            // login form, given correct credentials and on submit,
            // you should get access token & refresh token
            // store those tokens in your local storage
            // on subsequent requests, these token should also be included
            document.getElementById('login-form').onsubmit = handleLogin

            // logout: just delete the token from local storage
            document.getElementById('logout-form').onsubmit = handleLogout
        })

        const handleLogin = (event) => {
            event.preventDefault()
            fetch('http://localhost:8888/sso/token/', {
                method: "POST",
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(
                    {
                        'username': document.getElementById('username').value,
                        'password': document.getElementById('password').value,
                    }
                ),
            })
            .then(response => response.json())
            .then(data => {
                console.log(data)
                if (!('access' in data)) throw Error()
                localStorage.setItem('access', data.access)
                localStorage.setItem('refresh', data.refresh)
                document.getElementById('auth').innerHTML =
                    `<h3>Logged in as ${document.getElementById('username').value}</h3>`
                    document.getElementById('login-form-error').innerHTML = ''
            })
            .catch(error => {
                console.log(error)
                document.getElementById('login-form-error').innerHTML = 'ERROR - see console'
            })
        }

        const handleLogout = (event) => {
            event.preventDefault()
            localStorage.removeItem('access')
            localStorage.removeItem('refresh')
            document.getElementById('auth').innerHTML =
                '<h3>Logout successful.</h3>'
        }

        const getFeedbacks = () => {
            fetch('http://localhost:8888/portal/feedback/', {
                method: "GET",
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${localStorage.getItem('access')}`
                }
            })
            .then(response => {
                if (response.status == 401) {
                    document.getElementById('feedbacks').innerHTML =
                        `401 - unauthorized`
                }
                if (response.status == 403) {
                    document.getElementById('feedbacks').innerHTML =
                        `403 - forbidden`
                }
                return response.json()
            })
            .then(data => {
                console.log(data)
                document.getElementById('feedbacks').innerHTML = ''
                data.forEach(feedback => {
                    console.log(feedback)
                    document.getElementById('feedbacks').innerHTML +=
                        `Title: ${feedback.title}<br>
                        Type: ${feedback.type}<br>
                        Description: ${feedback.details}<br>
                        `
                })
            })
            .catch(error => console.log(error))
        }
    </script>
</body>
</html>